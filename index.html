<html>

	<head>
		<script type="text/javascript" src="videoproc.js"></script>
		<style>
			body {
				background: white;
				text-align: center;
			}
			#videoElement {
				visibility: hidden;
				position: absolute;
			}
			#hiddenCanvas {
				visibility: hidden;
				position: absolute;
			}
			#displayCanvas {
				position: relative;
				margin-left: auto;
				margin-right: auto;
			}
			#backgroundCanvas{
				position: absolute;
				top: 0px;
				left: 0px;
				width: 100%;
				height: 100%;
			}
			#display{
				border: 1px solid black;
				-webkit-box-shadow: 3px 3px 4px #000;
				-moz-box-shadow: 3px 3px 4px #000;
				box-shadow: 3px 3px 4px #000;
			}
		</style>
	</head>
	
	<body>
		<canvas id="backgroundCanvas"></canvas>		
		
		<div id="videoElement">
			<video id="videoPlayer" src="big_buck_bunny_480p_stereo.ogg" width="854" height="480" controls autoplay loop >
			Your browser does not support this video element.
			</video>
		</div>

		<div id="hiddenCanvas">
			<canvas id="hidden"></canvas> 
		</div>
		<div id="displayCanvas">
			<canvas id="display"></canvas>
		</div>
		
		<script>
			var videoPlayer = document.getElementById('videoPlayer');
			var displayDiv = document.getElementById('displayCanvas');
			var display = document.getElementById('display');
			var ctx = display.getContext('2d');
			
			var background = document.getElementById('backgroundCanvas');
			var bg = background.getContext('2d');
			
			var pause = false;
			display.width = videoPlayer.width;
			display.height = videoPlayer.height;
			displayDiv.style.top = background.height / 2;

			ctx.fillStyle = 'rgba(255,255,255,255)';
			ctx.fillRect(0,0,display.width,display.height);
			ctx.fillStyle = 'rgba(0,0,0,255)';
			ctx.font = '8pt sans-serif';
			var text = 'Loading...';
			var textMetrics = ctx.measureText(text);
			ctx.fillText(text,display.width/2 - textMetrics.width / 2,display.height/2);
			
			
			function drawLoop(){
				ctx.drawImage(videoPlayer,0,0,display.width,display.height);
				ambilight();
			}
			videoPlayer.addEventListener("play",setInterval(drawLoop,33));
			
			document.getElementById('display').onclick = function(){
				if(pause)
					videoPlayer.play();
				else
					videoPlayer.pause();
				pause = !pause;
			};
			
			function ambilight(){
				var imgData = ctx.getImageData(0,0,display.width,display.height);
				var color = {r:0,g:0,b:0};
				var pixels = 0;
				/*
				var pixelSkip = 16;
				for (var i = 0; i < imgData.data.length / (4 * pixelSkip); i++) {
					color.r += imgData.data[i * 4 * pixelSkip + 0];
					color.g += imgData.data[i * 4 * pixelSkip + 1];
					color.b += imgData.data[i * 4 * pixelSkip + 2];
					pixels++;
				}
				*/
				//we use random pixel samples instead of a regular n pixel skip
				//var samples = 25620;
				
				//slice into four pieces
				
				var samples = 25620;
				for(var i = 0; i < samples; i++){
					var indexX = Math.floor(imgData.width * Math.random());
					var indexY = Math.floor(imgData.height * Math.random());
					var pixel = getPixel(imgData,indexX,indexY);
					color.r += pixel.r;
					color.g += pixel.g;
					color.b += pixel.b;
				}
				color.r = Math.round(color.r / samples);
				color.g = Math.round(color.g / samples);
				color.b = Math.round(color.b / samples);
				color = "rgba("+color.r+","+color.g+","+color.b+",255)";
				
				bg.fillStyle = 'black';
				bg.fillRect(0,0,background.width,background.height);
				
				var imgCenter = {x:background.width / 2, y: background.height / 2};
				var gradient = bg.createRadialGradient(imgCenter.x,imgCenter.y,200,imgCenter.x,imgCenter.y,100);
				gradient.addColorStop(0,'rgba(0,0,0,0)');
				gradient.addColorStop(1,color);
				bg.fillStyle = gradient;
				bg.fillRect(0, 0, background.width, 2*background.height);
			}
			
			function getPixel(imgData,x,y){
				var index = (y*(imgData.width*4)) + (x*4);
				return {r:imgData.data[index],g:imgData.data[index+1],b:imgData.data[index+2],a:imgData.data[index+3]};
			}
		</script>
		
	</body>
</html>